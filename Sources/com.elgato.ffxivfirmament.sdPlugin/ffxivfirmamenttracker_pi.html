<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8" />
      <title>FFXIV Firmament Tracker</title>
      <link rel="stylesheet" href="sdpi.css">
   </head>
   <body>
      <div class="sdpi-item" id="server_select">
         <div class="sdpi-item-label">Server Select</div>
         <select class="sdpi-item-value select" id="server_menu"
                 onchange="document.getElementById('server_textbox').value = event.target.value;
                           updateSettingsToPlugin();"
                 value="">
             <option disabled="disabled" selected="selected" hidden="hidden"></option>
         </select>
      </div>
      <div class="sdpi-item">
         <div class="sdpi-item-label">Server</div>
         <input class="sdpi-item-value" id="server_textbox"
                placeholder="Select your server" value=""
                onchange="document.getElementById('server_menu').value = event.target.value, 
                          updateSettingsToPlugin();">
      </div>
      <div class="sdpi-item">
         <div class="sdpi-item-label">Button URL</div>
         <input class="sdpi-item-value" id="button_url"
                value=""
                placeholder="Enter a URL" onchange="updateSettingsToPlugin();">
      </div>
      <hr>
      <details>
         <summary>Advanced</summary>

         <div class="sdpi-item">
            <div class="sdpi-item-label">Firmament URL</div>
            <input class="sdpi-item-value" id="firmament_url"
                   value=""
                   placeholder="Builders' Progress Report URL" onchange="updateFirmamentUrl(event.target.value);">
         </div>
      </details>
      <!-- <div class="sdpi-item">
         <div class="sdpi-item-label">Debug</div>
         <input class="sdpi-item-value" id="debug_textbox"
                value=""
                placeholder="Debug" onchange="">
      </div>-->
      <script>
         // this is our global websocket, used to communicate from/to Stream Deck software
         // and some info about our plugin, as sent by Stream Deck software
         var websocket = null,
         uuid = null,
         actionInfo = {};
         
         function connectElgatoStreamDeckSocket(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
             uuid = inUUID;
             // please note: the incoming arguments are of type STRING, so
             // in case of the inActionInfo, we must parse it into JSON first
             actionInfo = JSON.parse(inActionInfo); // cache the info
             websocket = new WebSocket('ws://localhost:' + inPort);
         
             // if connection was established, the websocket sends
             // an 'onopen' event, where we need to register our PI
             websocket.onopen = function () {
                 var json = {
                     event:  inRegisterEvent,
                     uuid:   inUUID
                 };
                 // register property inspector to Stream Deck
                 websocket.send(JSON.stringify(json));
          
                 json = {
                     "event": "getGlobalSettings",
                     "context": uuid,
                 };
                 websocket.send(JSON.stringify(json));

                 json = {
                     "event": "getSettings",
                     "context": uuid,
                 };
                 websocket.send(JSON.stringify(json));
             }
         
             // retrieve saved settings if there are any
             websocket.onmessage = function (evt) {
                 // Received message from Stream Deck
                 const jsonObj = JSON.parse(evt.data);

                 if (jsonObj.event === 'didReceiveSettings') {
                     const payload = jsonObj.payload.settings;
         
                     if (payload.Server != undefined) {
                         document.getElementById('server_textbox').value = payload.Server;
                         document.getElementById('server_menu').value = payload.Server;
                     }
                     if (payload.OnClickUrl !== undefined) {
                         document.getElementById('button_url').value = payload.OnClickUrl;
                     }

                     updateSettingsToPlugin();
                 }
                 
                 if (jsonObj.event === 'didReceiveGlobalSettings') {
                     const payload = jsonObj.payload.settings;

                     // create dropdown menu
                     if (payload.hasOwnProperty('menu')) {
                         for (region in payload.menu) {
                             for (dc in payload.menu[region]) {
                                 for (s in payload.menu[region][dc]) {
                                     insertDropdownOption("server_menu", dc, s, s);
                                 }
                             }
                         }
                     }

                     if (payload.hasOwnProperty('FirmamentUrl')) {
                         document.getElementById('firmament_url').value = payload.FirmamentUrl;
                     }
                 }

                 // event to reload PI
                 if (jsonObj.event === 'sendToPropertyInspector') {
                     const payload = jsonObj.payload;

                     if (payload.hasOwnProperty('reload')) {
                         json = {
                             "event": "getGlobalSettings",
                             "context": uuid,
                         };
                         websocket.send(JSON.stringify(json));
                     }
                 }
             };
         }
         
         // update settings
         function updateSettingsToPlugin() {
             payload = {
                     'Server':document.getElementById('server_textbox').value,
                     'OnClickUrl':document.getElementById('button_url').value
             };

             sendValueToPlugin(payload);
             saveValues(payload);
         }

         // update the global setting containing the firmament url
         function updateFirmamentUrl(url) {
             payload = {
                     'FirmamentUrl':url
             };

             saveGlobalValues(payload);
         }

         // send a payload to plugin
         function sendValueToPlugin(payload) {
             if (websocket) {
                 const json = {
                         "action": actionInfo['action'],
                         "event": "sendToPlugin",
                         "context": uuid,
                         "payload": payload
                 };
                 websocket.send(JSON.stringify(json));
             }
         }

         // saves a global payload
         function saveGlobalValues(payload) {
             if (websocket) {
                 const json = {
                         "event": "setGlobalSettings",
                         "context": uuid,
                         "payload": payload
                 };
                 websocket.send(JSON.stringify(json));
             }
         }

         // saves a payload
         function saveValues(payload) {
             if (websocket) {
                 const json = {
                         "event": "setSettings",
                         "context": uuid,
                         "payload": payload
                 };
                 websocket.send(JSON.stringify(json));
             }
         }


         // inserts a radio button to buttons with specified id, with specified button name if it doesn't already exist
         function insertRadioButton(id, name, checked) {
             const radioEl = document.getElementById(id);

             if (radioEl.querySelector("input[id='" + name +"']") == null) {
                 newInput = document.createElement('input');
                 newInput.id = name;
                 newInput.type = "radio";
                 newInput.name = "rdio";
                 if (checked != null) {
                     newInput.checked = true;
                 }

                 newLabel = document.createElement('label');
                 newLabel.setAttribute("for", name);
                 newLabel.setAttribute("class", "sdpi-item-label");
                 // streamdeck requires the span to be here or the button doesn't show
                 newLabel.innerHTML = "<span></span>" + name;

                 newSpan = document.createElement('span');
                 newSpan.setAttribute("class", "sdpi-item-child");
                 newSpan.appendChild(newInput);
                 newSpan.appendChild(newLabel);

                 radioEl.appendChild(newSpan);
                 
                 radioEl.appendChild(document.createElement('br'));
             }
         }

         // inserts an option to specified optgroup ID in the tracker dropdown menu
         function insertDropdownOption(id, optgroupID, name, value) {
             menu = document.getElementById(id);
             var el = menu;
             
             if (optgroupID != null)  {
                 if (menu.querySelector("optgroup[label='" + optgroupID + "']") == null) {
                     grp = document.createElement('OPTGROUP');
                     grp.label = optgroupID;
                     menu.appendChild(grp);
                 }
                 el = menu.querySelector("optgroup[label='" + optgroupID + "']");
             }
          
             opt = document.createElement('OPTION');
             opt.textContent = name;
             opt.value = value;
             el.appendChild(opt);
         }
      </script>
   </body>
</html>