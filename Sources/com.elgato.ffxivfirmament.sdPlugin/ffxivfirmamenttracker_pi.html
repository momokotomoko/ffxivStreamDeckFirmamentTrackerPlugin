<!DOCTYPE html>
<html>
   <head>
      <meta charset="utf-8" />
      <title>FFXIV Firmament Tracker</title>
      <link rel="stylesheet" href="sdpi.css">
   </head>
   <body>
      <div class="sdpi-item" id="server_select">
          <div class="sdpi-item-label">Server Select</div>
          <select class="sdpi-item-value select" id="Server" 
                  onchange="sendValueToPlugin(event.target.value, 'Server');
                            saveValue(event.target.value, 'Server');
                            document.getElementById('server_textbox').value = event.target.value;">
              <option disabled="disabled" selected="selected" hidden="hidden"></option>
          </select>
      </div>
      <div class="sdpi-item">
          <div class="sdpi-item-label">Server</div>
          <input class="sdpi-item-value" id="server_textbox"
                 placeholder="Select your server" value=""
                 onchange="sendValueToPlugin(event.target.value, 'Server');
                           saveValue(event.target.value, 'Server');
                           document.getElementById('Server').value = event.target.value">
      </div>
      <script>
         // this is our global websocket, used to communicate from/to Stream Deck software
         // and some info about our plugin, as sent by Stream Deck software
         var websocket = null,
         uuid = null,
         actionInfo = {};
         
         function connectElgatoStreamDeckSocket(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
             uuid = inUUID;
             // please note: the incoming arguments are of type STRING, so
             // in case of the inActionInfo, we must parse it into JSON first
             actionInfo = JSON.parse(inActionInfo); // cache the info
             websocket = new WebSocket('ws://localhost:' + inPort);
         
             // if connection was established, the websocket sends
             // an 'onopen' event, where we need to register our PI
             websocket.onopen = function () {
                 var json = {
                     event:  inRegisterEvent,
                     uuid:   inUUID
                 };
                 // register property inspector to Stream Deck
                 websocket.send(JSON.stringify(json));

                 json = {
                     "event": "getGlobalSettings",
                     "context": uuid,
                 };
                 websocket.send(JSON.stringify(json));

                 json = {
                     "event": "getSettings",
                     "context": uuid,
                 };
                 websocket.send(JSON.stringify(json));

                 // send init message
                 sendValueToPlugin("true", "Init");
             }
         
             // retrieve saved settings if there are any
             websocket.onmessage = function (evt) {
                 // Received message from Stream Deck
                 const jsonObj = JSON.parse(evt.data);
                 if (jsonObj.event === 'didReceiveSettings') {
                     const payload = jsonObj.payload.settings;
         
                     if (payload.Server != null) {
                         document.getElementById('server_textbox').value = payload.Server;
                         document.getElementById('Server').value = payload.Server;
                     }
                     sendValueToPlugin(payload.Server, "Server");
                 }

                 if (jsonObj.event === 'didReceiveGlobalSettings') {
                     const payload = jsonObj.payload.settings;

                     if (payload.hasOwnProperty('menu')) {
                         for (region in payload.menu) {
                             for (dc in payload.menu[region]) {
                                 for (s in payload.menu[region][dc]) {
                                     insertDropdownOption("Server", dc, s, s);
                                 }
                             }
                         }
                     }
                 }
             };
         }
         
         // pass values to the plugin
         function sendValueToPlugin(value, param) {
             if (websocket) {
                 const json = {
                         "action": actionInfo['action'],
                         "event": "sendToPlugin",
                         "context": uuid,
                         "payload": {
                             [param] : value
                         }
                  };
                  websocket.send(JSON.stringify(json));
             }
         }
         
         // saves a payload
         function saveValue(value, param) {
             if (websocket) {
                 const json = {
                         "event": "setSettings",
                         "context": uuid,
                         "payload": {
                             [param] : value
                         }
                  };
                  websocket.send(JSON.stringify(json));
             }
         }

         // inserts a radio button to buttons with specified id, with specified button name if it doesn't already exist
         function insertRadioButton(id, name) {
             const radioEl = document.getElementById(id);

             if (radioEl.querySelector("input[id='" + name +"']") == null) {
                 newInput = document.createElement('input');
                 newInput.id = name;
                 newInput.type = "radio";
                 newInput.name = "rdio";

                 newLabel = document.createElement('label');
                 newLabel.for = name;
                 newLabel.class = "sdpi-item-label";
                 newLabel.textContent = name;
                 newLabel.appendChild(document.createElement('span'));

                 newSpan = document.createElement('span');
                 newSpan.class = "sdpi-item-child";
                 newSpan.appendChild(newInput);
                 newSpan.appendChild(newLabel);

                 radioEl.appendChild(newSpan);
                 
                 radioEl.appendChild(document.createElement('br'));
             }
         }

         // inserts an option to specified optgroup ID in the tracker dropdown menu
         function insertDropdownOption(id, optgroupID, name, value) {
             
             menu = document.getElementById(id);
             var el = menu;
             
             if (optgroupID != null)  {
                 if (menu.querySelector("optgroup[label='" + optgroupID + "']") == null) {
                     grp = document.createElement('OPTGROUP');
                     grp.label = optgroupID;
                     menu.appendChild(grp);
                 }
                 el = menu.querySelector("optgroup[label='" + optgroupID + "']");
             }
          
             opt = document.createElement('OPTION');
             opt.textContent = name;
             opt.value = value;
             el.appendChild(opt);
         }
      </script>
   </body>
</html>